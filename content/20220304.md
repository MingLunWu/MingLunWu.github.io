title: Pytest 101 - Python 開發者的測試入門
authors: MingLun Allen Wu
date: 2022-03-04 12:00:00
tags: Python, Test
category: Tool
summary: 待補
slug: pytest_101
top_image: https://images.unsplash.com/photo-1581472723648-909f4851d4ae?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1740&q=80
status: draft

# TL;DR

# 誰適合讀這篇？

+ 會寫 Python ，但沒有測試經驗

# 測試之旅

接觸 Python 也過了五六年了，曾使用 `Flask` 架設過平台，也有用過 `Pytorch` 建立 NLP 預測服務，但從來都沒有寫過測試。

當專案開發到一定的規模後，容易出現

## 基本架構

使用 Pytest 測試框架進行測試時，需要按照特定格式擺放檔案。

並沒有唯一正確的格式，身為一個廣泛使用的測試框架，`Pytest` 可依照使用者的需求自行指定

但是為了方便介紹，讓我們先以下面的架構進行說明：

(此架構同步更新在 [Github Repo](https://github.com/MingLunWu/pytest_101))

```
|
|_ Your Repo
    |
    |_ src/                  # 主要程式碼資料夾
        |_ module_a.py       # 範例模組 A
        |_ module_b.py       # 範例模組 B
    |
    |_ tests/                # 測試程式碼資料夾
        |_ test_module_a.py  # 模組 A 的測試程式碼
        |_ test_module_b.py  # 模組 B 的測試程式碼
    |
    |_ pytest.ini            # pytest 相關設定
```

從上述的架構我們可以掌握幾個原則 : 

+ 主要的程式碼會統一放在 `src/` (也有人稱為 `app`, `lib` 或直接用模組的用途命名) 
+ 測試用的程式碼則統一放在 `tests` 資料夾
+ 通常測試用的程式碼會以 `test_xxx.py` 命名 (我自己的習慣是直接對應到 `src/` 中的模組)

## 撰寫第一個測試

舉例來說，如果在 `src/module_a.py` 中撰寫了: 

```python
# src/module_a.py
    def square(num: int) -> int:
        """範例函式，回傳平方值

        Args:
            num (int): 數值

        Returns:
            int: 平方後的數值
        """
        return num**2
```

如果是一般的手動測試，我們可能會另外開一個 `test.py` 

```python
# test.py
from src.module_a import square

print(square(8)) # 得到 64
```

好！ 經過「肉眼」的判斷，這個函式寫對了！

使用 `pytest` 的做法，則是另外撰寫一小段程式碼來確認，這樣的測試函式**必須以`test`**開頭，通常稱為一個 "Test Case" : 

```python
# tests/test_module_a.py
from src.module_a import square

def test_square():
    assert square(8) == 64
```
### 執行第一個測試

寫好 Test Case 後，接著在 Terminal 執行: 

```bash
pytest -vv
```

`pytest` 會在執行測試時，自動至測試的資料夾(預設是 `tests`)尋找檔名為 `test_` 開頭的檔案，並且執行開頭為 `test_` 的函數。

執行測試後，會得到下列畫面: 

<img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20220304/pytest_1.png">

這意味著我們撰寫的第一個 Testing Case - `test_square` 成功通過了！

### 計算 Coverage

接著我們嘗試輸入 : 

```bash
pytest -vv --cov src/
```
`--cov src/` 意味著我們要在執行測試時，計算 `src/` 有多少比例的程式碼是「有被測試過」！

執行後則會得到下列結果：

<img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20220304/pytest_2.png">
