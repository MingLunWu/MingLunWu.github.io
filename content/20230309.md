title: Pytest 102 - 給 Python 開發者的測試入門(2) - mock
authors: MingLun Allen Wu
date: 2023-03-09 12:00:00
tags: Python, Test
category: Tool
summary: 待補
slug: pytest_102
top_image: https://images.unsplash.com/photo-1581472723648-909f4851d4ae?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1740&q=80
status: draft

## 前情提要

[Pytest 101 - 給 Python 開發者的測試入門](https://www.minglunwu.com/notes/2022/pytest_101.html)

## TL;DR

## 為什麼需要 `Mock` ?

在前一篇文章 : [Pytest 101 - 給 Python 開發者的測試入門](https://www.minglunwu.com/notes/2022/pytest_101.html) 中，我們了解到要寫出高品質的程式碼，測試案例是不可或缺的。

開發程式碼時，難免會與其他元件進行互動，例如透過 `requests` 套件取得特定網頁的資訊，但是在撰寫測試時，我們需要測試的是「程式碼」的邏輯是否正確。 當我們在測試時向外界取用資料，這樣很難確保在每一個測試的當下都是相同的。

舉個例子來說，我們寫了一個 `get_current_month()` 來取得現在的月份 : 

```python
# src/module_mock.py
from datetime import datetime
def get_current_month() -> int:
    today = datetime.now()

    month = today.month
    if month < 0:
        raise Exception("Wrong month")

    return today.month
```

接著我們寫一個簡單的測試函式，在這篇文章撰寫的當下 (2023/03/10)，我預期 `get_current_month()` 回傳的月份是 `3`：

```python
# tests/test_module_mock.py
from src.module_mock import get_current_month

def test_get_current_month():
    month = get_current_month()
    assert month == 3
```

問題來了！如果一個月後(2023/04/10)，我要進行測試，這時候測試案例會發生什麼事情？

測試**並不會通過**，因為這時候 `get_current_month()` 應該會回傳 `4`。

> 測試當下 `datetime.now()` 的結果會變動，導致每一次的測試環境都不相同

這種因為外部元件的數值發生變化導致測試難以執行，我們稱為與外部元件有**依賴關係** (Dependencies)

測試時會盡量避免與外部元件有依賴關係，**專注在程式碼內部的邏輯測試**。

另外一個常見的情況是透過 `requests` 套件去呼叫其他網站的 API 或是爬取內容，我們很難確保目標網站的 Response 都會保持恆定。

為了要消除這種依賴關係，這時候我們就需要 `Mock` 出場！

在 Python 中可以使用原生的套件 `unittest` 來協助建置 `Mock`，雖然還有其他套件如 `pytest_mock` 可以更方便的使用，但我們先從 `unittest` 開始：

```python
```

讓我們舉幾個例子：

## 案例 1 - 程式碼中有耗時很久的程式碼

我們試著建立一個檔案 : `src/module_mock.py`:

```python
# src/module_mock.py
import time

def sleep_for_a_while(seconds: int) -> int:
    """模擬一個需要執行有點久的函數

    Args:
        seconds (int): Pending 時間


    Returns:
        int: 回傳 Pending 秒數
    """
    print("Ready for sleeping!")
    time.sleep(seconds)
    return seconds
```

我們建立了一個函式 `sleep_for_a_while`，在這個函式中會使用 `time.sleep()` 暫停幾秒，然後回傳參數。

假設我們在測試資料夾中建立了一個對應的檔案 `tests/test_module_mock.py` : 

```python
from src.module_mock import sleep_for_a_while

def test_sleep_for_a_while():
    response = sleep_for_a_while(20)
    assert response==20
```

如果我們試著執行這個測試案例，會發生什麼事情呢？


<img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20230309/long_sleep.png">

因為在程式碼中有 `time.sleep(20)`，每次測試就會因為這行程式碼被卡 20 秒！

假如今天在程式碼中有許多地方都需要等待，那麼執行一次測試的時間就會重複疊加。

這時候我們就需要透過 `Mock` 發揮用場。

`Mock` 其實就是在執行測試的過程中，透過一個「暫時」的物件來取代部分的程式碼物件。

可以藉由 `Mock` 來確保測試過程沒有不必要的程式碼。

在 Python 中內建有 `unittest` 套件來提供 `Mock` 功能。

以上述例子 (`sleep_for_a_while()`) 來說，我們真正想要測試的是函式的 Input 和 Output 是否相同，實際上 `time.sleep()` 這一行沒有任何意義，我們希望在測試過程中暫時讓它消失！

```python
from src.module_mock import sleep_for_a_while

def test_sleep_for_a_while():
    response = sleep_for_a_while(20)
    assert response==20
```