<!DOCTYPE html>
<!--[if lt IE 9 ]><html class="no-js oldie" lang="en"> <![endif]-->
<!--[if IE 9 ]><html class="no-js oldie ie9" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
        <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">
    <!--
    <meta name="description" content="">
    <meta name="author" content="">
    -->
    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="https://minglunwu.github.io/theme/css/base.css">
    <!--<link rel="stylesheet" href="https://minglunwu.github.io/theme/css/vendor.css">-->
    <link rel="stylesheet" href="https://minglunwu.github.io/theme/css/main.css">
    <link rel="stylesheet" href="https://minglunwu.github.io/theme/css/styles.css">

    <!-- script
    ================================================== -->
    <script src="https://minglunwu.github.io/theme/js/modernizr.js"></script>
    <script src="https://minglunwu.github.io/theme/js/pace.min.js"></script>
    <!--<script src="https://kit.fontawesome.com/968a4ded4c.js" crossorigin="anonymous"></script>-->

    <!-- favicons
    ================================================== -->
    <link rel="shortcut icon" href="https://minglunwu.github.io/theme/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://minglunwu.github.io/theme/favicon.ico" type="image/x-icon">

    <title>不再被大量超參數及模型表現淹沒！使用MLFlow進行實驗管理</title>
    <meta property="og:title" content="不再被大量超參數及模型表現淹沒！使用MLFlow進行實驗管理">
    <meta name="description" content="<p>使用itertools搭配MLFlow Tracking 來進行多種參數組合的實驗管控。</p>">
    <meta property="og:description" content="<p>使用itertools搭配MLFlow Tracking 來進行多種參數組合的實驗管控。</p>">
    <meta name="author" content="MingLun Allen Wu">
    <meta property="og:image" content="https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80">
    
    <link rel="image_src" type="image/jpeg" href="https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80" />
    <style>
        img{
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body id="top">
            <!-- header
    ================================================== -->
    <header class="s-header">

        <div class="header-logo">
            <a class="site-logo" href="https://minglunwu.github.io"><img src="https://minglunwu.github.io/theme/images/logo.png" width="160" height="56" alt="Homepage"></a>
        </div>

        <nav class="header-nav-wrap">
            <ul class="header-nav">
                <li class="current"><a href="https://minglunwu.github.io/#home" title="home">Home</a></li>
                <li><a href="https://minglunwu.github.io/#about" title="about">About</a></li>
                <li><a href="https://minglunwu.github.io/#blog" title="blog">Blogs</a></li>
                <li><a href="https://minglunwu.github.io/#note" title="note">Notes</a></li>
                <!--<li><a class="smoothscroll" href="#note" title="notes">Notes</a></li>-->
                <!--<li><a class="smoothscroll"  href="#contact" title="contact">Contact</a></li>-->
            </ul>
        </nav>

        <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

    </header> <!-- end s-header -->

        <article class="blog-single">

            <!-- page header/blog hero
            ================================================== -->
            <div class="page-header page-header--single page-hero" style="background-image:url(https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80)">
            
                <div class="row page-header__content narrow">
                    <article class="col-full">
                        <div class="page-header__info">
                            <div class="page-header__cat">
                                    <a href="#0">MLFlow</a>
                            </div>
                        </div>
                        <h1 class="page-header__title">
                            <a href="#0" title="">
                                不再被大量超參數及模型表現淹沒！使用MLFlow進行實驗管理
                            </a>
                        </h1>
                        <ul class="page-header__meta">
                            <li class="date">2020- 5-27 (三)</li>
                            <li class="author">
                                By
                                <span>MingLun Allen Wu</span>
                            </li>
                        </ul>
                        
                    </article>
                </div>
        
            </div> <!-- end page-header -->
    
            <div class="row blog-content">
                <div class="col-full blog-content__main">
                    
                    <ul>
<li><a href="#前言">前言</a></li>
<li><a href="#重點摘要">重點摘要</a></li>
<li><a href="#使用-itertools-簡化多層迴圈">使用 itertools 簡化多層迴圈</a></li>
<li><a href="#introduction-to-mlflow">Introduction to MLFlow</a></li>
<li><a href="#示範案例---傳統方式">示範案例 - 傳統方式</a></li>
<li><a href="#使用-mlflow-tracking進行管理">使用 MLFlow Tracking進行管理</a></li>
<li><a href="#安裝">安裝</a></li>
<li><a href="#基本語法使用">基本語法使用</a></li>
<li><a href="#啟動-ui-dashboard">啟動 UI (Dashboard)</a></li>
<li><a href="#後記">後記</a></li>
</ul>
<hr>
<p><p id="前言"></p></p>
<h1>前言</h1>
<p>在訓練模型時，常需要使用不同的：</p>
<ol>
<li>超參數 (Learning Rate、Epoch、Batch_size...)</li>
<li>資料配置 (資料欄位、資料前處理方式的不同)</li>
<li>模型架構 (Ex: 使用特定層數的Layer進行Fine-tune)</li>
</ol>
<p>我原先是透過 <code>Notion.so</code>的表格來簡單紀錄：</p>
<p><img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20200527/notion.png"></p>
<p>然而每次模型訓練完成後，手動將結果填到表格上會遇到兩個心態上的掙扎:</p>
<ol>
<li>號稱在做人工智慧，居然還要手動將資料Key到表格中 xD</li>
<li>回顧結果時，都會擔心有沒有因為恍神而紀錄錯誤</li>
</ol>
<p>這些不同的組合將會產生大量的模型及指標，對這些資料進行妥善的管理，能夠節省許多心力，可以很方便的整理出超參數間的 Pattern，也較不會因為個人疏忽而漏記某些數據。</p>
<hr>
<p><p id="重點摘要"></p></p>
<h1>重點摘要</h1>
<p>本篇筆記的重點 : </p>
<ol>
<li>在產生多種超參數的組合時，使用 <code>itertools</code> 套件來取代 <code>多層迴圈</code>，讓程式碼的執行能更簡潔。</li>
<li>使用 <code>MLFlow</code>的 <code>tracking</code>功能取代原先的<code>手動紀錄</code>，協助管理：<ul>
<li>訓練前的參數配置</li>
<li>訓練過程的資訊</li>
<li>訓練後的各項指標</li>
</ul>
</li>
</ol>
<p>原先在做實驗時，如果有下列兩種參數選項: </p>
<div class="highlight"><pre><span></span><span class="n">max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">min_leaf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</pre></div>


<p>早期我會透過<code>兩個迴圈</code>來進行實驗，然後把 <code>結果 print</code>出來 （或是寫到CSV檔)</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">a_max_depth</span> <span class="ow">in</span> <span class="n">max_depth</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">a_min_leaf</span> <span class="ow">in</span> <span class="n">min_leaf</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SomeModel</span><span class="p">(</span><span class="n">a_max_depth</span><span class="p">,</span> <span class="n">a_min_leaf</span><span class="p">)</span>
        <span class="c1"># 下面進行訓練及驗證</span>
        <span class="c1"># .....</span>
        <span class="c1"># .....</span>
        <span class="c1"># .....</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max Depth: </span><span class="si">{}</span><span class="s2"> | Min Leaf: </span><span class="si">{}</span><span class="s2"> | Acc: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_max_depth</span><span class="p">,</span> <span class="n">a_min_leaf</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
</pre></div>


<p>當參數種類過多時，會需要過多層迴圈來進行參數組合。 </p>
<p>而使用print方式列印模型結果，對於模型表現的管理相當不方便。</p>
<p>透過MLFlow Tracking 管理後，可以透過 UI 介面得到下圖結果: </p>
<p><img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20200527/mlflow_ui.png"></p>
<p>此介面統整了所有的指標及超參數，所有實驗過程都一目了然。 </p>
<p>除此之外，還能針對特定項目進行篩選 (例如我想找所有 <code>testing accuracy &gt; 0.75</code>的訓練)。</p>
<hr>
<p><p id="使用-itertools-簡化多層迴圈"></p></p>
<h1>使用 itertools 簡化多層迴圈</h1>
<p>有多個超參數，需要比較各項組合時，常見的做法是使用巢狀迴圈:</p>
<div class="highlight"><pre><span></span><span class="n">param_a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">param_b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">param_c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">param_a</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">param_b</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">param_c</span><span class="p">:</span>
            <span class="c1"># 實際訓練的程式碼</span>
            <span class="n">doSomething</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>


<p>當參數的種類有很多時，需要使用相當多層的巢狀迴圈，使用 <code>itertools</code>可以得到較為簡潔的程式碼：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">param_a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">param_b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">param_c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># 透過 itertools.product 產生所有的變數組合</span>
<span class="n">all_combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">param_a</span><span class="p">,</span> <span class="n">param_b</span><span class="p">,</span> <span class="n">param_c</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">)</span>
<span class="c1"># [(1,1,1), (1,1,0.5), (1,1,0.25), (1,1,0),......,(5,3,0.25), (5,3,0)]</span>

<span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_combinations</span><span class="p">:</span>
    <span class="c1"># 實際訓練的程式碼</span>
    <span class="n">doSomething</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
</pre></div>


<hr>
<p><p id="introduction-to-mlflow"></p></p>
<h1>Introduction to MLFlow</h1>
<p><code>MLFlow</code>是一個Open Source 的平台，主要用來管理 Machine Learning 相關的流程，優勢在與「深度學習的框架」是獨立的，不論使用哪一種深度學習框架(<code>Tensorflow</code>、<code>Pytorch</code>)，都能很方便地與<code>MLFlow</code>進行整合。</p>
<p>MLFlow可以分為四項獨立的功能: </p>
<p><strong>1. MLFlow Tracking</strong></p>
<p><strong>2. MLFlow Projects</strong></p>
<p><strong>3. MLFlow Models</strong></p>
<p><strong>4. Model Registry</strong></p>
<p>各項功能是各自獨立的，你可以單獨使用其中一項功能，也能組合使用，本篇筆記將使用 <code>MLFlow Tracking</code>的功能來進行訓練指標的管理。</p>
<hr>
<p><p id="示範案例---傳統方式"></p></p>
<h1>示範案例 - 傳統方式</h1>
<p>我們舉一個實際例子來說明傳統方式與MLflow的差別:</p>
<ul>
<li>使用 <code>sklearn</code>的 <code>DecisionTreeClassifier</code> 來進行分類任務</li>
<li>Training Set 跟 Testing Set 透過 Numpy 來隨機產生。</li>
<li>此項任務的超參數有兩項:  (不知道是什麼意思也無所謂，反正就是我們想要監控的超參數）<ol>
<li>max_depth : 決定決策樹的深度。</li>
<li>min_leaf : 決定樹的葉節點容納個數。<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># 隨機產生資料</span>
<span class="n">train_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>

<span class="n">test_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>

<span class="c1"># 候選的超參數</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">min_leaf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># 使用 itertools 產生所有超參數的組合</span>
<span class="n">all_combination</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">min_leaf</span><span class="p">))</span>

<span class="k">for</span> <span class="n">a_max_depth</span><span class="p">,</span> <span class="n">a_min_leaf</span> <span class="ow">in</span> <span class="n">all_combination</span><span class="p">:</span>
    <span class="c1"># 使用特定參數組合訓練模型</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">a_max_depth</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="n">a_min_leaf</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>

    <span class="c1"># 驗證模型結果 (將結果以print方式呈現)</span>
    <span class="n">train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
    <span class="n">train_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">train_pred</span><span class="o">==</span><span class="n">train_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">train_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max Depth:</span><span class="si">{}</span><span class="s2"> | Min Leaf:</span><span class="si">{}</span><span class="s2"> | Training Accuracy:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_max_depth</span><span class="p">,</span> <span class="n">a_min_leaf</span><span class="p">,</span> <span class="n">train_acc</span><span class="p">))</span>

    <span class="n">test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">test_pred</span><span class="o">==</span><span class="n">test_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">test_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max Depth:</span><span class="si">{}</span><span class="s2"> | Min Leaf:</span><span class="si">{}</span><span class="s2"> | Testing Accuracy:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_max_depth</span><span class="p">,</span> <span class="n">a_min_leaf</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">))</span>
</pre></div>


</li>
</ol>
</li>
</ul>
<hr>
<p><p id="使用-mlflow-tracking進行管理"></p></p>
<h1>使用 MLFlow Tracking進行管理</h1>
<p id="安裝"></p>

<h2>安裝</h2>
<p>透過 <code>pip</code> 可以快速安裝</p>
<div class="highlight"><pre><span></span>pip install mlflow
</pre></div>


<p id="基本語法使用"></p>

<h2>基本語法使用</h2>
<p>與上一小節同樣的情境，但此次使用 MLFlow Tracking 功能進行管理，有以下幾個重點：</p>
<ul>
<li>
<p>使用MLFlow的功能時，需要將寫入指令放置在  <code>with mlflow.start_run():</code>的範圍中，常用的寫入指令包含：</p>
<ul>
<li><code>mlflow.log_param("參數名稱", "參數值")</code>: 寫入特定參數的值。</li>
<li><code>mlflow.log_metric("指標名稱", "指標值")</code>: 寫入特定指標的值。<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span> <span class="c1"># 所有的mlflow寫入指令必須放置在 mlflow.start_run 範圍中. </span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="c1"># 寫入超參數</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">2e-5</span><span class="p">)</span>
    <span class="c1"># ... 驗證程式碼 </span>
    <span class="c1"># ...</span>
    <span class="c1"># ...</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;train_acc&quot;</span><span class="p">,</span> <span class="n">train_acc</span><span class="p">)</span> <span class="c1"># 寫入指標</span>
</pre></div>


</li>
</ul>
</li>
<li>
<p>我們可以將 <code>with mlflow.start_run()</code>視為一次「嘗試」，所以在此範圍內:</p>
<ul>
<li>參數只能被設定一次。(你無法先設定 <code>batch_size=4</code> 接著又設定 <code>batch_size=8</code>，這並不合邏輯)</li>
<li>
<p>指標可以重複被更新. (例如 <code>training loss</code>就會根據訓練的 Step 持續更動），可以在寫入時加入 <code>step</code>參數來紀錄變動的過程:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="c1"># 參數只能被寫入一次</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#ok</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">2e-5</span><span class="p">)</span> <span class="c1">#ok</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># 會噴錯，因為參數在一個 `start_run()`中只能紀錄一次.</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50000</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;training_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span> <span class="c1"># metric 是可以持續被更新的.</span>
</pre></div>


<p>使用 <code>step</code>參數紀錄後，可以在 <code>tracking UI</code> 看到該指標的變化:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20200527/mlflow_step.png"></p>
</li>
</ul>
</li>
</ul>
<p>看到這裏，發現 mlflow的優點了嗎？ 其實只是使用 <code>mlflow</code>套件的 method進行寫入，就能達到Tracking的效果，跟使用什麼樣的深度學習框架完全無關。 你可以透過 <code>mlflow</code>很方便的「監控你有興趣的指標」。</p>
<p>現在我們嘗試將剛剛的示範情境，透過 <code>mlflow</code>進行管理:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># 隨機產生資料</span>
<span class="n">train_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>

<span class="n">test_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>

<span class="c1"># 候選的超參數</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">min_leaf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># 使用 itertools 產生所有超參數的組合</span>
<span class="n">all_combination</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">min_leaf</span><span class="p">))</span>

<span class="k">for</span> <span class="n">a_max_depth</span><span class="p">,</span> <span class="n">a_min_leaf</span> <span class="ow">in</span> <span class="n">all_combination</span><span class="p">:</span>
<span class="hll">    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span> <span class="c1"># 新增的程式碼</span>
</span><span class="hll">        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">,</span> <span class="n">a_max_depth</span><span class="p">)</span> <span class="c1"># 新增的程式碼</span>
</span><span class="hll">        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;min_leaf&quot;</span><span class="p">,</span> <span class="n">a_min_leaf</span><span class="p">)</span> <span class="c1"># 新增的程式碼</span>
</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">a_max_depth</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="n">a_min_leaf</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>

        <span class="n">train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
<span class="hll">        <span class="n">train_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">train_pred</span><span class="o">==</span><span class="n">train_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">train_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span>        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;train_acc&quot;</span><span class="p">,</span><span class="n">train_acc</span><span class="p">)</span> <span class="c1"># 新增的程式碼</span>

        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span>
<span class="hll">        <span class="n">test_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">test_pred</span><span class="o">==</span><span class="n">test_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">test_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span>        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;test_acc&quot;</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">)</span> <span class="c1"># 新增的程式碼</span>
</pre></div>


<p>只需要加入五行程式碼，就能在接下來的章節中透過 <code>mlflow UI</code>進行視覺化的管理，整合十分方便！</p>
<hr>
<p><p id="啟動-ui-dashboard"></p></p>
<h2>啟動 UI (Dashboard)</h2>
<p>當你在 python script 中執行 <code>mlflow</code>寫入功能後，預設會在當前資料夾產生 <code>mlruns</code>資料夾，你所寫入的資訊會儲存在其中。 你可以透過下列指令啟動 <code>mlflow UI</code>:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="s2">&quot;Your project folder&quot;</span>
mlflow ui <span class="c1"># 啟動 mlflow tracking dashboard</span>
</pre></div>


<p>執行成功後， <code>mlflow UI</code>預設會在 <code>127.0.0.1:5000</code>執行，進入後就能看到剛剛寫入的指標一目了然的以表格形式呈現:
<img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20200527/mlflow_ui_2.png"></p>
<p>除了呈現清楚外，還能進行 filter，例如我想要 「min_leaf  = 3」且 「test_acc &gt; 0.44」的結果:
<img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20200527/mlflow_filter.png"></p>
<p>或者是選定幾種不同的嘗試進行 compare ，內建有幾種簡單的圖表能讓你進行初步的視覺化:
<img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="https://minglunwu.github.io/images/20200527/mlflow_compare.png"></p>
<p>這些基本功能對於管理、比較大量的模型很有幫助，能夠針對自己的需求篩選出所需要的參數設置、甚至是透過基本的視覺化來找到一些特別的Pattern。</p>
<hr>
<p><p id="後記"></p></p>
<h1>後記</h1>
<p>這篇筆記的目的是希望能達到兩個目的:</p>
<ol>
<li>更有效率的組合各種超參數</li>
<li>使用MLFlow Tracking 來進行模型的管理</li>
</ol>
<p>在進行資料分析相關任務時，找尋最佳模型這個階段，程式碼的架構其實不會有太大的變動，只是某些「超參數」會有調整。
過去只知道使用Git來管理程式碼，卻疏忽「超參數」跟「模型」的管理也是相當重要的，畢竟<strong>這些變動的超參數只佔程式碼的一小部分，卻影響了我們真正在乎的結果。</strong></p>
<p>我認為使用這種管理模型及超參數的工具是有必要的，能夠省下許多整理結果、解讀結果的時間。很希望當時研究所時期在做論文實驗時能看到這種工具的介紹，所以寫下了這則筆記。</p>
<p>當然，MLFlow Tracking的功能遠遠不止這則筆記所提到的，我正開始將其整合進我個人的工作習慣中，也持續在摸索怎麼更有效率的使用它，不過希望透過這則筆記能讓你稍微了解有這種類型的工具在協助管理模型，甚至能真的幫助到你～</p>
<p>接下來會再慢慢摸索 MLFlow的其他功能，希望能分享更多的功能！ 附上MLFlow的官方網站～</p>
<p><a href="https://mlflow.org/docs/latest/index.html"> MLFlow 官方網站連結 </a></p>
<p>如果有任何經驗上的分享交流，請直接聯絡我吧！我很期待！ 下次見！</p>
    
                    <p class="blog-content__tags">
                        <span>Post Tags</span>
    
                        <span class="blog-content__tag-list">
                             <a href="#0">MLFlow</a>
                        </span>
    
                    </p>
    
                    <div class="blog-content__pagenav">
                        <div class="blog-content__nav">












                            <div class="blog-content__prev">
                                <a href="https://minglunwu.github.io/notes/2020/transformers-tutorial.html" rel="prev">
                                    <span>Previous Post</span>
                                    NLP深度學習不能不用的套件 - Transformers
                                </a>
                            </div>
                            <div class="blog-content__next">
                                <a href="https://minglunwu.github.io/notes/2020/20200520.html" rel="next">
                                    <span>Next Post</span>
                                    Python 平行化運算 - Multi-Processing
                                </a>
                            </div>
                        </div>
    
                        <div class="blog-content__all">
                            <a href="https://minglunwu.github.io/#note" class="btn btn--primary">
                                View All Post
                            </a>
                        </div>
                    </div>
    
                </div><!-- end blog-content__main -->
            </div> <!-- end blog-content -->
    
        </article>
            <!-- footer
    ================================================== -->
    <footer>
        <div class="row">
            <div class="col-full">

                <div class="footer-logo">
                    <a class="footer-site-logo" href="#0"><img src="https://minglunwu.github.io/theme/images/logo.png" alt="Homepage"></a>
                </div>
                <ul class="footer-social">
                    <li>
                        <a href="https://www.facebook.com/zebra52000" target="_blank"><i class="im im-facebook" aria-hidden="true"></i><span>Facebook</span></a>
                    </li>
                    <li>
                        <a href="https://medium.com/@allen6997535" target="_blank"><i class="im im-book" aria-hidden="true"></i><span>Medium</span></a>
                    </li>
                    <li>
                        <a href="https://github.com/MingLunWu" target="_blank"><i class="im im-github" aria-hidden="true"></i><span>Github</span></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/allen-ming-lun-wu-637020142/" target="_blank"><i class="im im-linkedin" aria-hidden="true"></i><span>LinkedIn</span></a>
                    </li>
                    <li>
                        <a href="https://www.instagram.com/whoisfater0724/" target="_blank"><i class="im im-instagram" aria-hidden="true"></i><span>Instagram</span></a>
                    </li>
                </ul>
                    
            </div>
        </div>

        <div class="row footer-bottom">

            <div class="col-twelve">
                <div class="copyright">
                    <span>© Copyright Hola 2017</span> 
                    <span>Design by <a href="https://www.styleshout.com/">styleshout</a></span>	
                </div>

                <div class="go-top">
                <a class="smoothscroll" title="Back to Top" href="#top"><i class="im im-arrow-up" aria-hidden="true"></i></a>
                </div>
            </div>

        </div> <!-- end footer-bottom -->

    </footer> <!-- end footer -->
    <!-- Java Script
        ================================================== -->
        <script src="https://minglunwu.github.io/theme/js/jquery-3.2.1.min.js"></script>
        <script src="https://minglunwu.github.io/theme/js/plugins.js"></script>
        <script src="https://minglunwu.github.io/theme/js/main.js"></script>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-161863471-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-161863471-1');
    </script>
    
</body>